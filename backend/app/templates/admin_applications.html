<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PetPal â€” Applications</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 24px;
    }

    h1 {
      margin-bottom: 6px;
    }

    .note {
      color: #555;
      margin-top: 0;
    }

    .error {
      color: #b00020;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 10px;
      vertical-align: top;
    }

    th {
      background: #f5f5f5;
      text-align: left;
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
    }

    .msg {
      white-space: pre-wrap;
      max-width: 520px;
    }

    .animalCell {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .thumb {
      width: 56px;
      height: 56px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid #ddd;
      background: #f3f3f3;
    }

    .animalText {
      line-height: 1.2;
    }

    .animalText small {
      color: #666;
    }

    .actionsCell {
      white-space: nowrap;
    }

    .actionBtn {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      margin-right: 6px;
    }

    .actionBtn:hover {
      background: #f7f7f7;
    }
  </style>
</head>

<body>
  <h1>Adoption Applications</h1>
  <p class="note">Temporary internal page (authentication will be added later).</p>

  <div id="status"></div>

  <table id="tbl" style="display: none;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Animal</th>
        <th>Applicant</th>
        <th>Contact</th>
        <th>Status</th>
        <th>Message</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function setStatus(appId, status) {
      try {
        const res = await fetch(`/animals/applications/${appId}/status`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          alert(err.error ? `Error: ${err.error}` : "Failed to update status.");
          return;
        }

        // Refresh list after update
        loadApplications();
      } catch (e) {
        alert("Network error updating status.");
      }
    }

    async function loadApplications() {
      const statusEl = document.getElementById("status");
      const table = document.getElementById("tbl");
      const tbody = document.getElementById("tbody");

      statusEl.textContent = "Loading applications...";
      statusEl.className = "";
      tbody.innerHTML = "";

      try {
        const res = await fetch("/animals/applications");
        if (!res.ok) throw new Error("Request failed: " + res.status);

        const data = await res.json();
        const apps = data.applications || [];

        if (apps.length === 0) {
          statusEl.textContent = "No applications yet.";
          table.style.display = "none";
          return;
        }

        statusEl.textContent = "";
        table.style.display = "table";

        for (const a of apps) {
          const tr = document.createElement("tr");

          const phone = a.phone || "-";
          const msg = a.message || "-";

          const animalImg = a.animal_image_url
            ? `<img class="thumb" src="${a.animal_image_url}" alt="${a.animal_name ?? "Animal"}" />`
            : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#777;">No Img</div>`;

          tr.innerHTML = `
            <td>${a.id}</td>
            <td>
              <div class="animalCell">
                ${animalImg}
                <div class="animalText">
                  <strong>${a.animal_name ?? "Unknown"}</strong><br />
                  <small>${a.animal_species ?? ""} (ID: ${a.animal_id})</small>
                </div>
              </div>
            </td>
            <td>
              <strong>${a.applicant_name}</strong><br />
              <small>${a.email}</small>
            </td>
            <td>${phone}</td>
            <td><span class="pill">${a.status}</span></td>
            <td class="msg">${escapeHtml(msg)}</td>
            <td class="actionsCell">
              <button class="actionBtn" onclick="setStatus(${a.id}, 'approved')">Approve</button>
              <button class="actionBtn" onclick="setStatus(${a.id}, 'denied')">Deny</button>
              <button class="actionBtn" onclick="setStatus(${a.id}, 'pending')">Reset</button>
            </td>
          `;

          tbody.appendChild(tr);
        }
      } catch (err) {
        statusEl.textContent = "Error loading applications: " + err.message;
        statusEl.className = "error";
        table.style.display = "none";
      }
    }

    loadApplications();
  </script>
</body>
</html>
